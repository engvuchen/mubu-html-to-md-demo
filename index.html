<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>幕布HTML转为MD</title>
  </head>
  <body>
    <input type="file" />
    <button>点击上传</button>
    <script>
      document.querySelector('button').onclick = async function () {
        // 单文件上传取第一个即可
        let file = document.querySelector('input').files[0];
        let fileName = file?.name || '';
        if (!fileName?.endsWith('.html')) {
          tips('仅支持 HTML 文件');
          return;
        }
        let res = await request({
          url: '/upload',
          method: 'POST',
          data: {
            'mubu-html': file,
          },
        });
        downloadByBlob(`${fileName.replace('.html', '.md')}`, res.md);
      };

      function request({
        url = '',
        method = 'GET',
        headers = {},
        data = {},
        onprogress = () => {},
        timeout = 1000,
        ontimeout = () => {},
      }) {
        return new Promise((resolve, reject) => {
          let xhr = new XMLHttpRequest();
          Object.keys(headers).forEach(key => {
            xhr.setRequestHeader(key, headers[key]);
          });
          xhr.upload.onprogress = onprogress;
          xhr.timeout = timeout;
          xhr.ontimeout = ontimeout;

          let sendData = null;
          let dataKeys = Object.keys(data);
          if (method === 'GET') {
            sendData = `${url}?`;
            let list = [];
            dataKeys.forEach(key => {
              list.push(`${key}=${data[key]}`);
            });
            sendData += `${list.join('&')}`;
          } else {
            sendData = new FormData();
            dataKeys.forEach(key => {
              sendData.append(key, data[key]);
            });
          }

          xhr.open(method, url);
          xhr.send(sendData);
          xhr.onload = () => {
            if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
              return resolve(JSON.parse(xhr?.response || '{}'));
            } else {
              return reject(res);
            }
          };
        });
      }
      function downloadByBlob(fileName, content) {
        let blob = new Blob([content], {
          type: 'text/plain;charset=utf-8',
        });
        let reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onload = function (e) {
          let a = document.createElement('a');
          a.download = fileName;
          a.href = e.target.result;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
      }
      function tips(msg) {
        alert(msg);
      }
    </script>
  </body>
</html>
